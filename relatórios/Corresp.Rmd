---
title: "Indicador de correspondência"
output:
  html_document: default
  pdf_document: default
---
```{r, echo = FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(tidyr)
library(tibble)
library(dplyr)
library(lubridate)
library(RColorBrewer)
library(ggrepel)
library(esquisse)
library(zoo)
library(forcats)
library(tidyverse)
library(gganimate)
library(gifski)
```


```{r setup, include=FALSE, warning=FALSE, message=FALSE}
pdata<- read.csv("sgdc_anom.csv", sep = ",")
```

## Apresentação 

Este relatório apresenta resultados preliminares da amálise exploratória dos dados do Sistema de Gestão da Defesa Civil. Propõe-se a criação de um novo indicador que pode ser usado para avaliar a confiabilidade dos dados estudados bem como a eficiência dos canais de atendimento em triar as solicitações que entram no sistema. 

O indicador consiste em um número em (%), representando a fração das amastras em que o ocorrência indicada na solicitação (ocorr_solic) é igual à ocorrência observada em campo e registrada pelo técnico no momento da vistoria (ocorr_vist).


## Os dados 

Foram utilizados os regisstros do SGDC correspondentes ao período de 01/07/2004 a 31/12/2019, inicialmente contendo **147512 observações e 16 variáveis**. 

```{r,warning=FALSE, message=FALSE}
head(pdata)
```

### Filtragem

Para as análises pretendidas, o primeiro requisito é que fossem selecionadas apenas as solicitações que foram atendidas e que possuem um tipo de ocorrência registrado pelo técnico vistoriados. Assim, foram eliminadas as observações de acordo com o valor das variáveis:

Status da solicitação (desc_status): CANCELADO, BLOQUEADO, PENDENTE, NÃO VISUALIZADA e VISTORIA PROGRAMADA. 
Canal de abertura (orig_solic): ABERTA EM CAMPO, OFÍCIO e OUVIDORIA. 

Optou-se por suprimir as solicitações com orig_solic = _ABERTA EM CAMPO_ pois, como as solicitações são também abertas no momento da vistoria pelo técnico vistoriador, ocorr_solic e ocorr_vist devem, por regra, serem iguais, o que desbalancearia a amostra. 
As solicitações abertas via _OFÍCIO_ e _OUVIDORIA_ foram desconsideradas por fugirem do escopo de interesse da análise. 

```{r, warning=FALSE, message=FALSE}
pdata <- pdata[!(pdata$desc_status == "CANCELADO"),]
pdata <- pdata[!(pdata$desc_status == "BLOQUEADO"),]
pdata <- pdata[!(pdata$desc_status == "PENDENTE"),]
pdata <- pdata[!(pdata$desc_status == "NÃO VISUALIZADA"),]
pdata <- pdata[!(pdata$desc_status == "VISTORIA PROGRAMADA"),]
pdata <- pdata[!(pdata$desc_orig_solic == "ABERTA EM CAMPO"),]
pdata <- pdata[!(pdata$desc_orig_solic == "OFICIO"),]
pdata <- pdata[!(pdata$desc_orig_solic == "OUVIDORIA"),]
pdata <- pdata[!(pdata$ocorr_vist == "NULL"),]


```

Também para facilitar a análise, as ocorrências _AVLIAÇÃO DE IMÓVEL ALAGADO_, _ALAGAMENTO DE IMÓVEL_ e _ALAGAMENTO DE IMÓVE_ foram sintetizadas em um único tipo _ALAGAMENTO_. 

### Modelagem

```{r, warning=FALSE, message=FALSE}
alagamentos <- c("AVALIAÇÃO DE IMÓVEL ALAGADO", "ALAGAMENTO DE IMÓVEL", "ALAGAMENTO DE ÁREA")
pdata$ocorr_solic <- ifelse(pdata$ocorr_solic %in% alagamentos, "ALAGAMENTO", pdata$ocorr_solic)
pdata$ocorr_vist <- ifelse(pdata$ocorr_vist %in% alagamentos, "ALAGAMENTO", pdata$ocorr_vist)

```

Por fim, criamos uma nova coluna no dataset, que deverá ter valor VERDADEIRO ( _TRUE_ ) se a ocorrência indicada na solicitação e a observada na vistoria coincidirem e FALSO ( _FALSE_ ) caso sejam diferentes. 

O conjunto de dados final contem 90.046 observações e 17 variáveis. 

```{r, echo = FALSE, , warning=FALSE, message=FALSE}
sdata <- pdata %>% mutate(match = ifelse(ocorr_solic == ocorr_vist, TRUE, FALSE))
head(sdata)
```

## Análises

### Univariada
O valor de C para cada ocorrência pode ser obsevado no gráfico a seguir. Observa-se que quatro ocorrências críticas, que exigem uma resposta imediata da Defesa Civil e demais órgãos do SMPDC, mostram valores entre 50% e 60%, enquanto outras três do tipo ficam abaixo dos 40%. 
Podemos dizer a partir daí que uma solicitação aberta como **deslizamento de terra** tem uma chance aproximada de 50% de **não** ser um deslizamento de terra real, as mesmas chances de tirar um "cara" ao lançar uma moeda. 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
prop <- sdata %>%  group_by(ocorr_solic) %>% 
                   summarise(C = mean(match)*100)

ocorr_emerg = c("DESLIZAMENTO DE TERRA", "DESABAMENTO DE IMOVEL", "DESABAMENTO DE MURO", "EXPLOSAO",
                 "PISTA ROMPIDA", "ARVORE CAIDA", "DESABAMENTO PARCIAL")
delete <- c("VAZAMENTO DE GÁS", "ORIENTAÇÃO TÉCNICA", "AVALIACAO DA AREA", "ARMAZENAMENTO DE MATERIAIS PERIGOSOS", "DESABAMENTO DE BLOCOS DE UMA PEDREIRA" )

prop_2 <- filter(prop, !(ocorr_solic %in% delete))%>%  
  mutate(name = fct_reorder(ocorr_solic, C)) %>%  
  mutate(resp = ifelse(ocorr_solic %in% ocorr_emerg, "Crítico", "Preventivo")) 
prop_2 <- prop_2[order(-prop_2$C ),]

prop_2 %>%      ggplot() + geom_bar(aes(x = name, y= C, fill = resp), stat = "identity") +
                               geom_text(aes(x=ocorr_solic, y = C, hjust = -0.1, label = paste0(round(C,1), "%")))+
                               scale_fill_manual(values = c("#3568ab", '#d9d9d9')) +
                               geom_hline(yintercept = 50,  color = "red", linetype = "dashed", size=0.9)+
                               theme_grey() +
                               coord_flip() +
                               theme(legend.position = "none")+
                               labs(title = "Indicador de correspondência (C) por tipo de ocorrência",
                                    caption = "Período analisado: 07/05/2020 a 31/12/2019. 
                                               Total de observações: 96051", 
                                    x = "Ocorrência",
                                    y = "C") 
```
É possível também, a partir desta primeira análise, investigar quais são as situações reais observadas pelo técnico em campo quando, não são as ocorrências indicadas no momento da abertura do chamado. Abaixo, temos a tabela com essas informações para as ocorrências destacadas no gráfico anterior. 

```{r}

prop_3 <- sdata[sdata$ocorr_solic %in% ocorr_emerg,] %>% group_by(ocorr_solic, ocorr_vist) %>% 
          summarise(n = n()) %>% 
          mutate(freq = n/sum(n)*100) %>%
          arrange(-freq, .by_group = TRUE) %>% 
          mutate(ocorr_vist = factor(ocorr_vist, levels = ocorr_vist)) %>% 
          select(-c(n)) %>% 
          as.data.frame()

 
```
Calculando essa tabela para _ORITENTAÇÃO TÉCNCIA_, um tipo de ocorrência coringa dentro do sistema, selecionado quando a ocorrência observada não se encaixa em nenhuma das tipologias disponíveis, observamos que aproximadamente 1/4 das solicitações são indicadas posteriormente pelo técnico como _AMEAÇA DE DESABAMENTO_. A maior parte é classidicada tanbém como _ORIENTAÇÃO TÉCNICA_, o que abre espaço para novas análises mais aprofundadas para verificar, talvez a partir das intervenções indicadas, se são atendimentos que fogem do escopo da Defesa Civil, ou mesmo identificar novas tipologias a serem inseridas na lista de ocorrências. 

```{r}

sdata[sdata$ocorr_solic == "ORIENTAÇÃO TÉCNICA",] %>% group_by(ocorr_vist) %>% 
          summarise(n = n()) %>% 
          mutate(freq = n/sum(n)*100) %>% 
          arrange(-freq)

          

```
### Multivariada 

Nesta seção dispomos as observações feitas a partir do cruzamento do Indicador (C) com outras variáveis, como canal de ocorrência, data de abertura do chamado e local. 

#### Qauntidade de solicitações e data de abertura



```{r}

os_dt = c("DESLIZAMENTO DE TERRA", "AMEACA DE DESLIZAMENTO")
os_db = c("DESABAMENTO DE IMOVEL", "AMEACA DE DESABAMENTO")


dt <- sdata[sdata$ocorr_solic %in% os_dt,] %>% group_by(year(data_solic), date(data_solic), ocorr_solic) %>% 
                                          summarise(n_solic = n(), C = mean(match)) %>% 
                                          filter(n_solic >= 10, `year(data_solic)` >= 2005, ocorr_solic == "DESLIZAMENTO DE TERRA") 
dt
#Gráfico de dispersão
dt %>%  ggplot(aes(x=n_solic, y=C, group = ocorr_solic)) + geom_point()+
        #stat_smooth(method =  "gam", col = "red")+ #facet_wrap(~ocorr_solic)+ 
        labs(title = "Gráfico de dispersão: número de solicitações (n_solic) x indicador (C)",
         subtitle = "Deslizamentos de terra. n de corte = 100", x = "número de solicitações", y = "indicador")


#gráfico de densisdade
dt %>% ggplot() + geom_density(aes(x=C)) +
       geom_vline(aes(xintercept = mean(C)),linetype = "dashed", size = 0.6)

#fUNÇÃO EMPIRICA DE DISTRIBUIÇÃO ACUMULADA
dt %>% ggplot(aes(sample=C)) + stat_qq( geom = "step", size = 1.5)


#Boxplot
dt %>% ggplot() + geom_boxplot(aes(x=C)) +coord_flip()


summary(dt)



```

#### Canal de abertura

Estudar a variação de (C) de acordo com a forma como as solicitações entram no sistema pode nos dar uma dimensão da qualidade da triagem feita pelos canais de atendimento. Espera-se que o atendente seja capaz de ouvir o relato do cidadão e registrá-lo no sistema de forma concisa, captando os detalhes cruciais e fornecendo aos setores responsáveis pelo roteiro de vistoria informções confiáveis para definir a prioridade de atendimento pelo órgão. 

Para as análises a seguir, serão consideradas as ocorrências de _AMEAÇA DE DESLIZAMENTO_ e _DESLIZAMENTO DE TERRA_, dada a sua relevância na rotina do órgão e sua homogeneidade durante o periíodo analisado. 

Sob essa perspectiva, analisamos a primeira hipótese, que é um senso comum dentro da CODESAL: _"Desde que saiu da sede do órgão, em 2015, a qualidade do atendimento 199 caiu"_. Essa afirmação parte da premissa que, enquanto na sede, os atendentes do 199 poderiam ser melhor orientados pelos técnicos, podendo tirar dúvidas e recebendo correções de imediato. Além disso, agora que estão trabalhando no formato de Call Center, os atendentes recbem chamados não só do 199 mas também do telefone da Ouvidoria Geral do Município. É rezoável considerar, então, que o atendimento presencial da CODESAL, aqui entitulado _PESSOALMENTE_ deve apresentar um valor de C no mínimo maior que o valor para os atendimentos feitos pelo 199. 

Contudo, o que observamos nos gráficos abaixo nega a hipótese: além de não podermos dizer que houve uma queda de C para o 199 a partir de 2015, para deslizamentos de terra o 199 é mais acertivo que o atendimento presencial  
```{r}




sdata[sdata$ocorr_solic %in% os_dt & sdata$desc_orig_solic %in% c("199", "PESSOALMENTE"),] %>% group_by(year(data_solic), desc_orig_solic) %>% 
                                         summarise(n = mean(match)*100) %>% 
                                         ggplot() + geom_line(aes(x = `year(data_solic)`, y = n, colour = as.factor(desc_orig_solic)), size = 1.2) +                      
                                          coord_cartesian(xlim =c(2005, 2019), ylim = c(0, 100)) +   
                                         scale_x_continuous(breaks = seq(2005,2019, 2))+
                                         theme(legend.position = "bottom", legend.box = "horizontal")+
                                          labs(title = "Indicador de verdadeiro-positivo (C) por canal de atendimento",
                                              caption = "Período analisado: 07/05/2020 a 31/12/2019", 
                                              x = "Ano",
                                              y = "C",
                                              colour = "Canal de aberura") 

sdata[sdata$ocorr_solic %in% os_dt & sdata$desc_orig_solic %in% c("199", "PESSOALMENTE"),] %>% group_by(year(data_solic), ocorr_solic, desc_orig_solic) %>% 
                                         summarise(n = mean(match)*100) %>% 
                                         ggplot() + geom_line(aes(x = `year(data_solic)`, y = n, colour = as.factor(ocorr_solic)), size = 1.2) +                                                                 #facet_wrap(~desc_orig_solic) +
                                          coord_cartesian(xlim =c(2005, 2019), ylim = c(0, 100)) +   
                                         scale_x_continuous(breaks = seq(2005,2019, 2))+
                                         theme(legend.position = "bottom", legend.box = "horizontal")+
                                          labs(title = "Indicador de verdadeiro-positivo (C) por canal de atendimento",
                                              caption = "Período analisado: 07/05/2020 a 31/12/2019", 
                                              x = "Ano",
                                              y = "C",
                                              colour = "Canal de aberura") 

sdata[sdata$ocorr_solic == "ALAGAMENTO" & sdata$desc_orig_solic %in% c("199", "PESSOALMENTE"),] %>% group_by(year(data_solic), desc_orig_solic) %>% 
                                         summarise(n = mean(match)*100) %>% 
                                         ggplot() + geom_line(aes(x = `year(data_solic)`, y = n, colour = as.factor(desc_orig_solic)), size = 1.2) +                      
                                          coord_cartesian(xlim =c(2005, 2019), ylim = c(0, 100)) +   
                                         scale_x_continuous(breaks = seq(2005,2019, 2))+
                                         theme(legend.position = "bottom", legend.box = "horizontal")+
                                          labs(title = "Indicador de verdadeiro-positivo (C) por canal de atendimento",
                                              caption = "Período analisado: 07/05/2020 a 31/12/2019", 
                                              x = "Ano",
                                              y = "C",
                                              colour = "Canal de aberura") 


```





